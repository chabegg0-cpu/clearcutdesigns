<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Label Sheet Builder (Private)</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f6;
      color: #222;
    }
    header {
      background: #111827;
      color: #e5e7eb;
      padding: 12px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header small {
      font-size: 11px;
      color: #9ca3af;
    }
    .auth-info {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .auth-info button {
      font-size: 12px;
      padding: 4px 8px;
    }
    main {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: calc(100vh - 54px);
    }
    aside {
      background: #111827;
      color: #e5e7eb;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }
    .section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin: 0 0 8px 4px;
      color: #9ca3af;
    }
    .list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .list-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid transparent;
      background: transparent;
      transition: background 0.12s, border-color 0.12s;
      font-size: 13px;
    }
    .list-item:hover {
      background: rgba(249, 250, 251, 0.04);
      border-color: rgba(156, 163, 175, 0.5);
    }
    .list-item.selected {
      background: rgba(37, 99, 235, 0.25);
      border-color: #60a5fa;
    }
    .list-thumb {
      width: 40px;
      height: 40px;
      border-radius: 4px;
      overflow: hidden;
      background: #111827;
      flex-shrink: 0;
    }
    .list-thumb svg {
      width: 60px;
      height: 60px;
      transform: translate(-10px, -10px);
    }
    .list-title {
      font-size: 13px;
      line-height: 1.25;
      color: #e5e7eb;
      word-break: break-word;
    }
    section.builder {
      padding: 16px 20px 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .builder-header {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .builder-header h2 {
      margin: 0;
      font-size: 18px;
    }
    .builder-header small {
      font-size: 13px;
      color: #6b7280;
    }
    .builder-body {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
      flex: 1;
      min-height: 0;
    }
    .tool-panel {
      background: #ffffff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .tool-panel h3 {
      margin: 0 0 8px;
      font-size: 14px;
      color: #374151;
    }
    .round-label-canvas {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.04);
    }
    .round-label-canvas img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .round-label-canvas .placeholder {
      color: #9ca3af;
      font-size: 13px;
      text-align: center;
      padding: 20px;
    }
    .upload-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }
    .upload-btn {
      appearance: none;
      border: 1px solid #cbd5f5;
      background: #2563eb;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      transition: background 0.12s, border-color 0.12s;
    }
    .upload-btn:hover {
      background: #1d4ed8;
      border-color: #2563eb;
    }
    #image-upload {
      display: none;
    }
    .preview-panel {
      background: #ffffff;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
    }
    .preview-panel h3 {
      margin: 0 0 8px;
      font-size: 14px;
      color: #374151;
    }
    #sheet-preview-wrapper {
      width: 796px;
      height: 1124px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      overflow: auto;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 8px;
      box-sizing: border-box;
    }
    #sheet-preview svg {
      display: block;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      /* Match the template exactly - 210mm Ã— 297mm at screen resolution */
      width: 796px;
      height: 1124px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
    }
    .controls .name-group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .controls label {
      font-size: 13px;
      color: #374151;
    }
    .controls input[type="text"] {
      border-radius: 6px;
      border: 1px solid #d1d5db;
      padding: 5px 8px;
      font-size: 13px;
      min-width: 140px;
    }
    button {
      appearance: none;
      border: 1px solid #cbd5f5;
      background: #2563eb;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
    }
    button.secondary {
      background: white;
      color: #111827;
      border-color: #d1d5db;
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .status-text {
      font-size: 12px;
      color: #6b7280;
    }
    .empty-state {
      font-size: 13px;
      color: #6b7280;
      text-align: center;
      padding: 20px 8px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      aside {
        flex-direction: row;
        overflow-x: auto;
        overflow-y: hidden;
        height: 140px;
      }
      .builder-body {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
    }
  </style>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>Label Sheet Builder</h1>
      <small>Private builder: generates A4-ready SVG sheets and saves them into a Drive folder used by the public library.</small>
    </div>
    <div class="auth-info">
      <div id="auth-status">Not signed in</div>
      <div>
        <button id="sign-in-btn" class="secondary">Sign in with Google</button>
        <button id="sign-out-btn" class="secondary" style="display:none;">Sign out</button>
      </div>
    </div>
  </header>

  <main>
    <aside>
      <div>
        <div class="section-title">Base label SVGs (design assets)</div>
        <div id="label-list" class="list"></div>
      </div>
    </aside>

    <section class="builder">
      <div class="builder-header">
        <h2 id="builder-title">Label Sheet Builder</h2>
        <small id="builder-subtitle">Upload an image to create your label, then generate an A4 sheet.</small>
      </div>

      <div class="builder-body">
        <div class="tool-panel">
          <h3>Label Design</h3>
          
          <div class="round-label-canvas" id="round-canvas">
            <div class="placeholder">No image uploaded</div>
          </div>
          
          <div class="upload-section">
            <input type="file" id="image-upload" accept="image/*">
            <button class="upload-btn" id="upload-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              Upload Image
            </button>
            <span class="status-text" id="image-status"></span>
          </div>
        </div>

        <div class="preview-panel">
          <h3>A4 Sheet Preview</h3>
          <div id="sheet-preview-wrapper">
            <div class="empty-state" id="preview-empty">Upload an image to generate your label sheet.</div>
            <div id="sheet-preview" style="display:none;"></div>
          </div>
          <div class="controls">
            <div class="name-group">
              <label for="design-name-input">Sheet name:</label>
              <input id="design-name-input" type="text" placeholder="e.g. Peach" />
            </div>
            <button id="download-btn" disabled>Download A4 SVG</button>
            <button id="save-drive-btn" class="secondary" disabled>Save to Drive</button>
            <span class="status-text" id="save-status"></span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // === CONFIG ===
    const CLIENT_ID = "515692635432-a7ul2sghm4356u9a26q34a4m6he12cg2.apps.googleusercontent.com";
    const API_KEY = "AIzaSyDQ9_K5QeGbDg5lViC4cjkKEdfuA79AVO4";
    const LABELS_FOLDER_ID = "169MZEkGQBB3yYQSzI93-6Fy-EFICaKYH"; // Base Labels
    const SHEETS_FOLDER_ID = "1x0OgilwMlkVb_w9KGzBod1PoAI_k824X"; // Sheets
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    // === DOM references ===
    const builderTitleEl = document.getElementById("builder-title");
    const builderSubtitleEl = document.getElementById("builder-subtitle");

    const sheetPreviewEl = document.getElementById("sheet-preview");
    const previewEmptyEl = document.getElementById("preview-empty");

    const roundCanvas = document.getElementById("round-canvas");
    const imageUpload = document.getElementById("image-upload");
    const uploadBtn = document.getElementById("upload-btn");
    const imageStatus = document.getElementById("image-status");

    const designNameInput = document.getElementById("design-name-input");
    const downloadBtn = document.getElementById("download-btn");
    const saveDriveBtn = document.getElementById("save-drive-btn");
    const saveStatusEl = document.getElementById("save-status");

    const authStatusEl = document.getElementById("auth-status");
    const signInBtn = document.getElementById("sign-in-btn");
    const signOutBtn = document.getElementById("sign-out-btn");

    // === In-memory state ===
    let currentSheet = null; // { svg, coords, name, labelName }
    let uploadedImageDataUrl = null; // data URL of uploaded image
    let uploadedImageFileName = null;

    let gapiInited = false;

    function updateAuthUi(isSignedIn, userEmail) {
      if (isSignedIn) {
        authStatusEl.textContent = userEmail ? `Signed in as ${userEmail}` : "Signed in";
        signInBtn.style.display = "none";
        signOutBtn.style.display = "inline-flex";
      } else {
        authStatusEl.textContent = "Not signed in";
        signInBtn.style.display = "inline-flex";
        signOutBtn.style.display = "none";
      }
    }

    async function initGapiClient() {
      return new Promise((resolve, reject) => {
        gapi.load("client:auth2", async () => {
          try {
            await gapi.client.init({
              apiKey: API_KEY,
              clientId: CLIENT_ID,
              discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
              scope: SCOPES,
            });

            gapiInited = true;

            const authInstance = gapi.auth2.getAuthInstance();
            const updateFromInstance = () => {
              const isSignedIn = authInstance.isSignedIn.get();
              const user = authInstance.currentUser.get();
              const profile = user && user.getBasicProfile ? user.getBasicProfile() : null;
              const email = profile ? profile.getEmail() : null;
              updateAuthUi(isSignedIn, email);
            };

            authInstance.isSignedIn.listen(updateFromInstance);
            updateFromInstance();

            resolve();
          } catch (err) {
            console.error("Error initializing gapi client", err);
            reject(err);
          }
        });
      });
    }

    signInBtn.addEventListener("click", async () => {
      try {
        if (!gapiInited) {
          await initGapiClient();
        }
        const authInstance = gapi.auth2.getAuthInstance();
        await authInstance.signIn();
      } catch (err) {
        console.error("Sign-in failed", err);
      }
    });

    signOutBtn.addEventListener("click", async () => {
      try {
        const authInstance = gapi.auth2.getAuthInstance();
        await authInstance.signOut();
      } catch (err) {
        console.error("Sign-out failed", err);
      }
    });

    // === Image Upload Handling ===

    uploadBtn.addEventListener("click", () => {
      imageUpload.click();
    });

    imageUpload.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        uploadedImageDataUrl = event.target.result;
        uploadedImageFileName = file.name;

        // Display in round canvas with proper circular clip
        roundCanvas.innerHTML = `
          <svg width="200" height="200" viewBox="0 0 200 200">
            <defs>
              <clipPath id="canvas-clip">
                <circle cx="100" cy="100" r="100" />
              </clipPath>
            </defs>
            <rect width="200" height="200" fill="white" />
            <image 
              href="${uploadedImageDataUrl}" 
              x="0" y="0" 
              width="200" height="200" 
              clip-path="url(#canvas-clip)"
              preserveAspectRatio="xMidYMid slice"
            />
          </svg>
        `;

        imageStatus.textContent = `Loaded: ${file.name}`;

        // Generate A4 sheet from the image
        generateSheetFromImage(uploadedImageDataUrl, file.name);
      };
      reader.readAsDataURL(file);
    });

    // === A4 sheet generation from uploaded image ===

    function generateSheetFromImage(imageDataUrl, fileName) {
      // Original pixel coordinates and sizes (from source SVG template)
      const xPx = [579.06993, 401.57263, 223.37416, 45.476175];
      const yPx = [34.992503, 212.55212, 389.86244, 568.07383, 746.28521, 922.59435];
      const labelWidthPx = 170.57071;
      const labelHeightPx = 170.30001;

      // A4 dimensions in mm (matching template exactly)
      const svgWidthMm = 210;
      const svgHeightMm = 297;

      // Conversion ratios (mm per pixel)
      const ratioX = svgWidthMm / 796;  // 0.2638196
      const ratioY = svgHeightMm / 1124; // 0.2642359
      const ratioAvg = (ratioX + ratioY) / 2; // 0.26402775

      // Convert all coordinates to millimeters
      const xMm = xPx.map(v => Number((v * ratioX).toFixed(2)));
      const yMm = yPx.map(v => Number((v * ratioY).toFixed(2)));
      const labelWidthMm = Number((labelWidthPx * ratioAvg).toFixed(2));
      const labelHeightMm = Number((labelHeightPx * ratioAvg).toFixed(2));

      const cols = xMm.length;
      const rows = yMm.length;

      // Generate SVG matching the template structure exactly
      let svg = '';
      svg += `<svg xmlns="http://www.w3.org/2000/svg" width="${svgWidthMm}mm" height="${svgHeightMm}mm" viewBox="0 0 ${svgWidthMm} ${svgHeightMm}">`;
      
      // Generate all clipPaths in a single defs block (like template)
      svg += '<defs>';
      let index = 1;
      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const x = xMm[col];
          const y = yMm[row];
          const clipId = `clip-${index}`;
          
          svg += `<clipPath id="${clipId}">`;
          svg += `<rect x="${x}" y="${y}" width="${labelWidthMm}" height="${labelHeightMm}" />`;
          svg += `</clipPath>`;

          index++;
        }
      }
      svg += '</defs>';

      // Full background image (like template)
      svg += `<image href="${imageDataUrl}" width="${svgWidthMm}" height="${svgHeightMm}" x="0" y="0" preserveAspectRatio="none" />`;

      // Generate all label overlays (circles with images)
      index = 1;
      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const x = xMm[col];
          const y = yMm[row];
          const clipId = `clip-${index}`;

          // White background circle
          const cx = x + labelWidthMm / 2;
          const cy = y + labelHeightMm / 2;
          const r = labelWidthMm / 2;
          svg += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="white" />`;

          // Image using transform matrix (same as template)
          svg += `<image `;
          svg += `href="${imageDataUrl}" `;
          svg += `width="1" height="1" `;
          svg += `preserveAspectRatio="none" `;
          svg += `transform="matrix(${labelWidthMm},0,0,${labelHeightMm},${x},${y})" `;
          svg += `clip-path="url(#${clipId})" `;
          svg += `/>`;

          index++;
        }
      }

      svg += '</svg>';

      const defaultName = fileName.replace(/\.[^/.]+$/, "");
      const name = `${defaultName}x24.svg`;

      currentSheet = {
        name,
        labelName: defaultName,
        svg,
        coords: [],
      };

      setCurrentSheet(currentSheet);
      updateSaveButtonEnabled();
    }

    function setCurrentSheet(sheet) {
      currentSheet = sheet;

      previewEmptyEl.style.display = "none";
      sheetPreviewEl.style.display = "block";
      sheetPreviewEl.innerHTML = sheet.svg;

      downloadBtn.disabled = false;
      updateSaveButtonEnabled();
    }

    function showPreviewError(msg) {
      sheetPreviewEl.style.display = "none";
      previewEmptyEl.style.display = "block";
      previewEmptyEl.textContent = msg;
      downloadBtn.disabled = true;
      saveDriveBtn.disabled = true;
    }

    // === Helpers for name + button state ===

    function hasValidDesignName() {
      return designNameInput.value.trim().length > 0;
    }

    function updateSaveButtonEnabled() {
      saveDriveBtn.disabled = !currentSheet || !hasValidDesignName();
    }

    designNameInput.addEventListener("input", () => {
      saveStatusEl.textContent = "";
      const baseName = designNameInput.value.trim();
      if (currentSheet && baseName) {
        currentSheet.name = `${baseName}x24.svg`;
      }
      updateSaveButtonEnabled();
    });

    // === Download current sheet as SVG (local) ===

    downloadBtn.addEventListener("click", () => {
      if (!currentSheet) return;
      const blob = new Blob([currentSheet.svg], { type: "image/svg+xml" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = currentSheet.name || "label-sheet-A4.svg";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // === Save current sheet + base SVG into Google Drive ===

    async function ensureSignedIn() {
      if (!gapiInited) {
        await initGapiClient();
      }
      const authInstance = gapi.auth2.getAuthInstance();
      if (!authInstance.isSignedIn.get()) {
        await authInstance.signIn();
      }
      return authInstance.currentUser.get();
    }

    function uploadSvgToDrive(name, svgText, folderId) {
      const boundary = "-------314159265358979323846";
      const delimiter = "\r\n--" + boundary + "\r\n";
      const closeDelim = "\r\n--" + boundary + "--";

      const metadata = {
        name,
        mimeType: "image/svg+xml",
        parents: [folderId],
      };

      const multipartRequestBody =
        delimiter +
        "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
        JSON.stringify(metadata) +
        "\r\n" +
        delimiter +
        "Content-Type: image/svg+xml\r\n\r\n" +
        svgText +
        closeDelim;

      return gapi.client.request({
        path: "/upload/drive/v3/files",
        method: "POST",
        params: { uploadType: "multipart" },
        headers: {
          "Content-Type": "multipart/related; boundary=" + boundary,
        },
        body: multipartRequestBody,
      });
    }

    saveDriveBtn.addEventListener("click", async () => {
      if (!currentSheet || !uploadedImageDataUrl || !hasValidDesignName()) return;

      const baseName = designNameInput.value.trim();
      const baseFileName = `${baseName}.svg`;
      const sheetFileName = `${baseName}x24.svg`;

      saveStatusEl.textContent = "Saving to Drive...";

      try {
        await ensureSignedIn();

        // Generate a simple SVG for the base label
        const baseSvg = generateBaseSvg(uploadedImageDataUrl);

        // Upload the base label SVG into the Base Labels folder
        const baseResp = await uploadSvgToDrive(baseFileName, baseSvg, LABELS_FOLDER_ID);

        // Upload the generated A4 sheet into the Sheets folder
        const sheetResp = await uploadSvgToDrive(sheetFileName, currentSheet.svg, SHEETS_FOLDER_ID);

        const baseId = baseResp && baseResp.result && baseResp.result.id;
        const sheetId = sheetResp && sheetResp.result && sheetResp.result.id;

        if (baseId && sheetId) {
          saveStatusEl.textContent = `Saved as "${baseName}" (base + A4 sheet).`;
        } else {
          saveStatusEl.textContent = "Saved, but response missing one or more IDs.";
        }
      } catch (err) {
        console.error("Upload failed", err);
        saveStatusEl.textContent = "Error saving to Drive (see console).";
      }
    });

    function generateBaseSvg(imageDataUrl) {
      // Generate a simple circular label SVG for the base
      const size = 170;
      const r = size / 2;

      return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
        <defs>
          <pattern id="base-image" patternUnits="userSpaceOnUse" width="${size}" height="${size}">
            <image href="${imageDataUrl}" x="0" y="0" width="${size}" height="${size}" preserveAspectRatio="xMidYMid slice" />
          </pattern>
        </defs>
        <rect width="${size}" height="${size}" fill="white" />
        <circle cx="${r}" cy="${r}" r="${r}" fill="url(#base-image)" />
      </svg>`;
    }

    // === Init ===
  </script>
</body>
</html>
